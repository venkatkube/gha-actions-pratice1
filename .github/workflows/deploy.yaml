name: CI / Deploy

on:
	push:
		branches: [ main ]
	pull_request:
		branches: [ main ]

permissions:
	contents: read
	pages: write
	id-token: write

concurrency:
	group: ci-deploy-${{ github.ref }}
	cancel-in-progress: true

jobs:
	lint:
		name: Lint
		runs-on: ubuntu-latest
		steps:
			- uses: actions/checkout@v4
			- uses: actions/setup-node@v4
				with:
					node-version: '20'
			- name: Cache node modules
				uses: actions/cache@v4
				with:
					path: ~/.npm
					key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
					restore-keys: |
						${{ runner.os }}-node-
			- name: Install dependencies
				run: npm ci
			- name: Lint
				run: npm run lint --if-present

	build:
		name: Build
		needs: lint
		runs-on: ubuntu-latest
		steps:
			- uses: actions/checkout@v4
			- uses: actions/setup-node@v4
				with:
					node-version: '20'
			- name: Install
				run: npm ci
			- name: Build
				run: npm run build

	test:
		name: Test
		needs: build
		runs-on: ubuntu-latest
		steps:
			- uses: actions/checkout@v4
			- uses: actions/setup-node@v4
				with:
					node-version: '20'
			- name: Install
				run: npm ci
			- name: Run tests
				run: npm test

	deploy:
		name: Deploy
		needs: test
		runs-on: ubuntu-latest
		if: github.ref == 'refs/heads/main'
		steps:
			- uses: actions/checkout@v4
			- uses: actions/setup-node@v4
				with:
					node-version: '20'
			- name: Install
				run: npm ci
			- name: Build
				run: npm run build
			- name: Deploy to GitHub Pages
				uses: peaceiris/actions-gh-pages@v3
				with:
					publish_dir: ./dist
					github_token: ${{ secrets.GITHUB_TOKEN }}

